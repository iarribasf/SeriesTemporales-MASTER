---
title: "Series acotadas"
author: "Iván Arribas (Depto. Análisis Económico. Universitat de València)"
subtitle: "Máster de Bioestadística (Modelización Estadística)"
toc: false
number-sections: true
bibliography: references.bib
crossref:
  fig-title: Figura
  tbl-title: Tabla
  fig-prefix: Figura
  tbl-prefix: Tabla
---

```{r}
#| echo: false
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, 
                      error = FALSE,
                      comment = "",
                      fig.align = "center", 
                      fig.show = "hold",
                      fig.height = 4,
                      fig.width = 8,
                      out.width = "80%")
```

```{r}
#| echo: false
library(forecast)
library(ggplot2); theme_set(theme_bw())
```

\
\

# Series Acotadas

En ocasiones, por la naturaleza de la serie, es necesario que las predicciones sean positivas o que permanezcan dentro de cierto intervalo $[a,\; b]$.

-   Todas las series que hemos visto en este curso deben ser positivas: nacimientos, libros publicados, consumo eléctrico, pasajeros, aforo...
-   Si la serie fuera un porcentaje, podría ser necesario que permaneciera acotada entre 0% y 100%.

## Predicciones positivas {-}

Para imponer que las predicciones sean positivas basta trabajar con la transformación logarítmica. Por ejemplo, consideremos la serie anual de nacimientos. Vamos ha realizar predicciones a muy largo plazo (30 años) usando Alisado de Holt con y sin transformación logarítmica.

```{r}
#| echo: false
nacimientos <- read.csv2("./series/Nacimientos.csv", header = TRUE)
nacimientos <- ts(nacimientos[, 2]/1000,start = c(1975, 1),freq = 12)
nacimientos <- aggregate(nacimientos, FUN = sum)
nacimientos <- window(nacimientos, end = 2019)
```

En el panel superior de la @fig-NacimientosHolt, donde se ha usado la transformación logarítmica, no solo la predicción, sino también el intervalo es siempre positivo. Por el contrario, en el panel inferior de la @fig-NacimientosHolt, donde no se ha usado la transformación logarítmica, las predicciones a partir de 2042 ya son negativas y el extremo inferior del intervalo de confianza es negativo desde el año 2028.

```{r}
#| label: fig-NacimientosHolt
#| layout-nrow: 2
#| fig-cap: "Ajuste y predicción de Nacimientos con Holt"
#| fig-subcap: 
#|   - "Con transformación logarítmica"
#|   - "Sin transformación logarítmica"
ConLog <- forecast(ets(nacimientos,
                       model = "AAN", 
                       damped = FALSE, 
                       lambda = 0),
                   h = 30,
                   level = 95)

SinLog <- forecast(ets(nacimientos, 
                       model = "AAN", 
                       damped = FALSE),
                   h = 30,
                   level = 95)

autoplot(ConLog, main = "", xlab = "", ylab = "Nacimientos (miles)")

autoplot(SinLog, main = "", xlab = "", ylab = "Nacimientos (miles)") + 
  geom_hline(yintercept=0, size = .3, linetype = 2)
```



## Predicciones dentro de un intervalo {-}

Supongamos que el valor de la serie es un porcentaje y que debe estar comprendido entre $a = 0$ y $b = 100$, como por ejemplo la serie anual consistente en el porcentaje de nacimientos de mujeres con nacionalidad española. La transformación que garantiza que las predicciones se mantendrán dentro del intervalo $[a,\;b]$ es

$$z_t = \log\Big(\frac{y_t - a}{b - y_t}\Big),$$ 
donde $y_t$ es la serie original y $z_t$ la serie transformada. Una vez tenemos las predicciones de la serie $z_t$, tenemos que deshacer la transformación con

$$y_t = \frac{a +b\, e^{z_t}}{1 + e^{z_t}}.$$

En este caso no hay un argumento *lambda* que nos facilite el trabajo y hay que escribir más código.

```{r}
#| echo: false
serie <- c(89.64,	87.98,	86.44,	85.17,	83.70,	
           81.21, 79.35,	79.45,	79.63,	80.69,	
           80.94,	81.61,	82.39,	82.38,	81.80,	
           80.98,	79.57,	78.00,	77.38, 78.65)
serie <- ts(serie, start = 2002, freq = 1)
```

```{r}
#| label: fig-Pre
#| fig-cap: "Predicción con Holt. Valores acotados entre 0% y 100%"
a <- 0
b <- 100

z <- log((serie - a) / (b - serie))

modelo <- ets(z, 
              model = "AAN", 
              damped = FALSE)

pz <- forecast(modelo, 
               h = 30,
               level = 95)

pz[["mean"]] <-  (a + b * exp(pz[["mean"]]) ) / (1 + exp(pz[["mean"]]))
pz[["lower"]] <- (a + b * exp(pz[["lower"]])) / (1 + exp(pz[["lower"]]))
pz[["upper"]] <- (a + b * exp(pz[["upper"]])) / (1 + exp(pz[["upper"]]))
pz[["x"]] <- serie

autoplot(pz, 
         main = "",
         xlab = "",
         ylab = "Nacimientos de mujeres españolas (%)")
```

Hemos solicitado una previsión a 30 años vista para poder ver mejor el efecto de *acotar* la serie. En la @fig-Pre se observa que no solo la predicción, sino también el intervalo está siempre entre 0% y 100%.

\
\
\
\

