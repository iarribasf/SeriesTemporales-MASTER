---
title: "Defunciones por Enfermedades Cerebrovasculares"
subtitle: "Procesos estocásticos"
author: "Iván Arribas (Depto. Análisis Económico. Universitat de València)"
toc: true
toc-title: Índice
number-sections: true
bibliography: references.bib
crossref:
  fig-title: Figura
  tbl-title: Tabla
  fig-prefix: Figura
  tbl-prefix: Tabla
---

```{r}
#| label: chunk_setup
#| echo: false
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, 
                      comment = "",
                      fig.align = "center", 
                      fig.show = "hold",
                      fig.height = 4,
                      fig.width = 8,
                      out.width = "80%") 
```


```{r}
#| label: librerias
#| echo: false
library(forecast)
library(ggplot2); theme_set(theme_bw())
library(urca)
```

# Introducción

Consideremos la serie temporal correspondiente al número de defunciones causadas por enfermedades cerebrovasculares, Esta serie está disponible en el Instituto Nacional de Estadística desde enero de 1980 hasta diciembre de 2023, un total de 44 años o 528 meses.

En la descriptiva vimos que la descomposición revelaba la presencia de varios valores atípicos concentrados al inicio de la serie. Por este motivo, vamos a recortar la serie y considerarla solo desde enero de 1990, 34 años o 408 meses.

La serie presenta tendencia decreciente y estacionalidad de orden 12 en un claro esquema multiplicativo (véase @fig-ECB). Ya vimos que el determinante principal del efecto estacional es la temperatura.


```{r}
#| label: fig-ECB
#| fig-cap: "Defunciones causadas por enfermedades cerebrovasculares"
DefEnfCer <- read.csv2("./series/Enfermedades cerebrovasculares.csv", 
                       header = TRUE)

DefEnfCer <- ts(DefEnfCer[,2], 
                start = 1980, 
                frequency = 12)

DefEnfCer <- window(DefEnfCer, 
                    start = 1990)

autoplot(DefEnfCer,
         xlab = "",
         ylab = "Defunciones",
         main = "") +
  scale_x_continuous(breaks= seq(1990, 2024, 2)) 
```

Veamos que transformaciones son necesarias para lograr que la serie sea estacionaria y ergódica.

\
\

# Transformación logarítmica

El esquema multiplicativo aconseja el uso del logaritmo para el análisis de la serie. Veamos que transformación de Box-Cox nos sugiere `R`:

```{r}
(nl <- BoxCox.lambda(DefEnfCer))
wDefEnfCer <-BoxCox(DefEnfCer, lambda = nl)
```

El valor sugerido de $\lambda=-0.55$ está alejado de 0 y es difícil de interpretar. Afortunadamente la @fig-ECB2 muestra que la transformación logarítmica (panel inferior) genera una serie muy similar a la transformación de Box-Cox óptima (panel medio); y que ambas series transformadas tienen una varianza más constante que la serie original (panel superior).

```{r}
#| label: fig-ECB2
#| fig-cap: "Defunciones causadas por enfermedades cerebrovasculares y algunas transformaciones"
#| fig-height: 6
series <- cbind("Original" = DefEnfCer,
                "Transformación Box-Cox" = wDefEnfCer,
                "Logaritmo" = log(DefEnfCer))
autoplot(series, facets = TRUE,
         xlab = "",
         ylab = "",
         main = "")
```

Concluimos que **se usará el logaritmo de las defunciones causadas por enfermedades cerebrovasculares** en lugar de la serie original.

\
\

# Diferenciaciones

Una vez decidida la transformación logarítmica, usaremos la FAC para determinar las diferenciaciones necesarias para alcanzar una serie estacionaria en media y ergódica.

```{r}
#| eval: false
ggAcf(log(DefEnfCer), lag = 48, ylim = c(-1, 1))
ggAcf(diff(log(DefEnfCer)), lag = 48, ylim = c(-1, 1))
ggAcf(diff(log(DefEnfCer), lag = 12),lag = 48, ylim = c(-1, 1))
ggAcf(diff(diff(log(DefEnfCer), lag=12)), lag = 48, ylim = c(-1, 1))
```

```{r}
#| echo: false
#| fig-height: 5
#| label: fig-ECBFAC
#| fig-cap: "FAC para Defunciones (log)"
#| fig-subcap: 
#|   - "Serie original"
#|   - "Dif. regular de la serie"
#|   - "Dif. estacional de la serie"
#|   - "Dif. regular y estacional de la serie"
#| layout: [[45, -10, 45], [45, -10, 45]]
ggAcf(log(DefEnfCer), lag = 48, ylim = c(-1, 1),
      main = "", xlab = "", 
      ylab = expression("log("*y[t]*")"))
ggAcf(diff(log(DefEnfCer)), lag = 48, ylim = c(-1, 1),
      main = "", xlab = "", 
      ylab = expression(nabla*"log("*y[t]*")"))
ggAcf(diff(log(DefEnfCer), lag = 12),lag = 48, ylim = c(-1, 1), 
      main = "", xlab = "", 
      ylab = expression(nabla[12]*"log("*y[t]*")"))
ggAcf(diff(diff(log(DefEnfCer), lag=12)), lag = 48, ylim = c(-1, 1), 
      main = "", xlab = "", 
      ylab = expression(nabla*nabla[12]*"log("*y[t]*")"))
```


Los dos paneles superiores de la @fig-ECBFAC muestran que ni el logaritmo de la serie, ni su tasa de variación mensual $(\nabla \log(y_t))$ son ergódicas. Obsérvese que en ambos casos ni al cabo de 48 retardos los coeficientes de autocorrelación son nulos.

Claramente, la doble diferencia del logaritmo de la serie es estacionaria y ergódica porque el panel (d) muestra que sólo unos pocos coeficientes de autocorrelación son no nulos.

La tasa de variación anual $(\nabla_{12} \log(y_t))$ no ofrece resultados tan claros. El panel (c) muestra una rápida caída de los valores de la autocorrelación en la parte regular (primeros valores de retardo), pero siguen observándose valores no nulos para valores de retardo altos.

Por otro lado, las funciones `ndiffs`y `nsdiffs` avalan la doble diferenciación regular y estacional.

```{r}
ndiffs(log(DefEnfCer))
nsdiffs(log(DefEnfCer))
```

Concluimos que **para alcanzar la estacionariedad y verificar la hipótesis de ergodicidad es necesario diferenciar tanto en su parte regular como estacional el logaritmo de la serie**: $log({y_t}) \sim I_{12}(1)I(1)$. Es decir, la serie que verifica todas las hipótesis es $\nabla \nabla_{12} log({y_t})$.

Para finalizar, mostramos gráficamente la serie original y la serie transformada (@fig-ECB3), así como la FAC y FACP de la serie transformada (@fig-ECBDisplay).

```{r}
#| label: fig-ECB3
#| fig-cap: "Defunciones causadas por enfermedades cerebrovasculares. Serie original y transformada"
#| fig-height: 5
series <- cbind("Original" = DefEnfCer,
                "Dif reg. y est. de log" = diff(diff(log(DefEnfCer), lag = 12)))
autoplot(series, facets = TRUE,
         xlab = "",
         ylab = "",
         main = "")
```

```{r}
#| label: fig-ECBDisplay
#| fig-cap: "Defunciones por enfermedades cerebrovasculares, FAC y FACP de la serie transformada"
#| fig-height: 5
ggtsdisplay(diff(diff(log(DefEnfCer)), lag = 12))
```

\
\


# Contraste KPSS

Vamos a analizar la estacionariedad en media a partir del contraste de raíces unitarias. Como la serie original tiene estacionalidad, vamos a realizar la prueba KPSS a partir de la serie anualizada, ya mostrada en la descriptiva (véase @fig-ECBAnual).

```{r}  
#| label: fig-ECBAnual
#| fig-cap: "Defunciones anuales causadas por enfermedades cerebrovasculares"
DefEnfCerAnual <- aggregate(DefEnfCer, FUN = sum)

autoplot(DefEnfCerAnual,
         xlab = "",
         ylab = "",
         main = "") 
```

Procedemos con la prueba de KPSS con y sin tendencia determinista:

```{r}
summary(ur.kpss(DefEnfCer, type='tau', lags = 'short'))
```

Para un nivel de confianza del 5%, si asumimos la presencia de tendencia determinista (`type = tau`), entonces no hay tendencia estocástica --el estadístico de contraste 0.0445 es menor que el valor crítico 0.146. 

```{r}
summary(ur.kpss(DefEnfCer, type='mu', lags = 'short'))
```

Si asumimos que no hay tendencia determinista, entonces hay tendencia estocástica --el estadístico de contraste 6.07 es mayor que el valor crítico 0.463. 

En ambos casos **concluimos que la serie no es estacionaria**.

Si repetimos el contraste con la serie diferenciada, esta vez para un modelo sin tendencia determinista (`type = mu`) no se rechaza la hipótesis nula, la serie diferenciada no tiene raíces unitarias y puede considerarse estacionaria.

```{r}
summary(ur.kpss(diff(DefEnfCer), type='mu', lags = 'short'))
```

La serie anual de defunciones es integrada de orden uno $y_t \sim I(1)$.

\
\
\
\
