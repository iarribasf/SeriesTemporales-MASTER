---
title: "Defunciones por Enfermedades Cerebrovasculares"
subtitle: "Definición y componentes"
author: "Iván Arribas (Depto. Análisis Económico. Universitat de València)"
toc: true
toc-title: Índice
number-sections: true
bibliography: references.bib
crossref:
  fig-title: Figura
  tbl-title: Tabla
  fig-prefix: Figura
  tbl-prefix: Tabla
---

```{r}
#| label: chunk_setup
#| echo: false
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, 
                      comment = "",
                      fig.align = "center", 
                      fig.show = "hold",
                      fig.height = 4,
                      fig.width = 8,
                      out.width = "80%") 
```



```{r}
#| label: librerias
#| echo: false
library(forecast)
library(ggplot2); theme_set(theme_bw())
```

\
\

# Introducción

Consideremos la serie temporal correspondiente al número de defunciones causadas por enfermedades cerebrovasculares. Esta serie está disponible en el Instituto Nacional de Estadística desde enero de 1980 hasta diciembre de 2023, un total de 44 años y 528 observaciones.

La serie y su fechado están en el fichero "Enfermedades cerebrovasculares.csv".


```{r}
DefEnfCer <- read.csv2("./series/Enfermedades cerebrovasculares.csv", 
                       header = TRUE)

DefEnfCer <- ts(DefEnfCer[,2], 
                start = 1980,
                freq = 12)
```

\
\

# Análisis preliminar gráfico

La gráfica de la serie temporal (@fig-ECB) muestra una **tendencia** decreciente en el número de muertes causadas por enfermedades cerebrovasculares en España. 

Las líneas verticales de la @fig-ECB marcan los meses de enero de cada año y permiten identificar mejor el posible **patrón estacional**. Aparentemente las muertes causadas por enfermedades cerebrovasculares tiene una mayor incidencia en invierno. Más adelante se hará un análisis detallado de la estacionalidad.

```{r}
#| label: fig-ECB
#| fig-cap: "Defunciones causadas por enfermedades cerebrovasculares"
autoplot(DefEnfCer,
         xlab = "",
         ylab = "Casos",
         main = "") +
  scale_x_continuous(breaks= seq(1980, 2024, 2)) 
```

Conforme disminuye el número de muertes año tras año, también disminuye la amplitud estacional. En los 80 la diferencia entre los meses con más y con menos incidencia de la enfermedad era muy acusada (aproximadamente 2500 casos), mientras que en los últimos años esta diferencia es más reducida (unos 600 casos). Parece, por tanto, que estamos ante un **esquema multiplicativo**. La @fig-ECBEsquema permite ver que los años con mayor número de defunciones se corresponden con una mayor variabilidad intraanual, por lo que confirmamos el esquema multiplicativo de la serie.

```{r}
#| label: fig-ECBEsquema
#| fig-cap: "Análisis del tipo de esquema"
CasosAnual = aggregate(DefEnfCer, FUN = sum)
DesviacionAnual = aggregate(DefEnfCer, FUN = sd)

ggplot() +
  geom_point(aes(x = CasosAnual, y = DesviacionAnual), size = 2) +
  xlab("Total de casos") + 
  ylab("Desviación típica") + 
  ggtitle("") 
```


\
\

# Análisis de las componentes

\

## Tendencia

Hemos obtenido la serie anual de casos de defunciones causadas por enfermedades cerebrovasculares, que se muestra en la @fig-ECBTendencia y que permite analizar mejor la tendencia decreciente. A primeros de los 80 el número de defunciones prácticamente alcanzaba las 50,000 al año, mientras que actualmente están por debajo de las 25,000. Esto supone una caída media anual de 1.6% en el número de defunciones. Parece que la Covid-19 no ha tenido ningún efecto sobre el número de defunciones.

```{r}
#| label: fig-ECBTendencia
#| fig-cap: "Tendencia de las defunciones anuales causadas por enfermedades cerebrovasculares"
autoplot(CasosAnual,
         xlab = "",
         ylab = "Casos",
         main = "") +
  scale_x_continuous(breaks= seq(1980, 2024, 4)) 
```

\

## Estacionalidad

Veamos ahora como varía la incidencia de las muertes causadas por enfermedades cerebrovasculares según el mes del año. 

```{r}
#| label: fig-ECBEstacional
#| fig-cap: "Gráfico estacional: defunciones por enfermedades cerebrovasculares"
ggsubseriesplot(DefEnfCer, 
             xlab = "",
             ylab = "",
             main = "") +
  guides(colour=FALSE)
```

Cada subserie en la @fig-ECBEstacional vuelve a mostrar la reducción en las defunciones causadas por enfermedades cerebrovasculares durante el periodo de análisis. Respecto de la estacionalidad, se aprecia que el principal determinante es la temperatura puesto que la incidencia de la enfermedad es mayor en los meses de invierno y menor en los de verano. También cabría esperar un efecto *días del mes* y observar más incidencia en los meses de 31 días que en los de 30, pero el efecto de la temperatura es tan dominante que camufla cualquier otro efecto. Sin embargo, para el mes de febrero se ve muy claramente el efecto días de mes. Por temperatura febrero debería situarse a medio camino entre enero y marzo, pero por ser un mes con solo 28 días (29 los años bisiestos) la media de defunciones es menor y se sitúa al mismo nivel que marzo. 

\
\

# Descomposición

Vamos a obtener cada una de las componentes de la serie usando el método de medias móviles `decompose`. Se ha optado por este método dado que la serie muestra un esquema multiplicativo.

```{r}
#| label: fig-ECBDescomposicion
#| fig-cap: "Descomposición multiplicativa por medias móviles"
#| fig-height: 7
DefEnfCerDesMul <- decompose(DefEnfCer, 
                             type = "mult")
autoplot(DefEnfCerDesMul,
         xlab = "",
         main = "")
```

La **tendencia** obtenida tras la descomposición confirma lo ya observado, una tendencia decreciente en los casos de defunciones por enfermedad cerebrovascular. 

También se aprecian muy claramente varios valores atípicos en el **residuo** al inicio del periodo de análisis, a finales del pasado siglo, al inicio de la pasada década y tras la pandemia.

Respecto de la **componente estacional**, se confirma el análisis preliminar: alta incidencia en invierno, especialmente en diciembre y enero, y muy baja en verano, destacando septiembre. En concreto, en enero se detectan un 24% más de casos de defunciones respecto de la media anual, en diciembre un 14% más y en los meses de febrero y marzo un 8% y 9% más, respectivamente. Por contra, en septiembre se observa un descenso del 16%. Cabría preguntarse las causas de la baja incidencia de junio o el repunte en julio, muy acusadas para atribuirse solo a un posible efecto *días del mes*.

```{r}
round(DefEnfCerDesMul$figure, 2)
```

A fin de aislar de la componente estacional el efecto *días del mes* del efecto de la temperatura, se ha aplicado la descomposición a la serie *defunciones por día* causadas por enfermedad cerebrovascular resultante de dividir la serie original por el número de días del mes (que obtenemos con la función `monthdays`). En esta nueva serie todo el efecto estacional se deberá a la temperatura.

La @fig-ECBEstacional2 muestra que la componente estacional estimada para las defunciones por día es más suave que la componente obtenida a partir la serie original. También se aprecia que el efecto del tamaño del mes es muy acusado en febrero. Para este mes el efecto estacional es el resultado de dos fuerzas opuestas: la baja temperatura incrementa el número de defunciones pero el tamaño del mes (28 días) las reduce. Sobre la serie original ambas fuerzas tienen lugar y el resultado es una componente estacional para febrero similar a la de marzo. En la serie de defunciones por día el efecto número de días del mes ha sido eliminado, solo queda el efecto temperatura y por eso la componente de febrero se sitúa entre la de enero y marzo.

El fenómeno opuesto se observa en el mes de agosto respecto del mes de junio. Aunque agosto es un mes cálido (menos defunciones) tiene 31 días (más defunciones) y el resultado final en la serie original es que presenta las mismas defunciones que junio, un mes menos cálido pero de 30 días. En la serie corregida por el número de días del mes, donde solo el efecto de la temperatura es relevante, el mes agosto tiene menos defunciones que junio.


```{r}
#| label: fig-ECBEstacional2
#| fig-cap: "Componente estacional de defunciones por enf. cerebrovasculares"
DefEnfCerDiaDesMul <- decompose(DefEnfCer/monthdays(DefEnfCer), 
                                type = "mult")

ggplot() +
  geom_line(aes(x = 1:12, y = DefEnfCerDesMul$figure, colour = "black")) + 
  geom_line(aes(x = 1:12, y = DefEnfCerDiaDesMul$figure, colour = "red")) + 
  geom_hline(yintercept = 1, colour = "blue", lty = 2) +
  ggtitle("") +
  xlab("") +
  ylab("Efecto estacional") +
  scale_x_continuous(breaks= 1:12, 
                     labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", 
                                "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")) +
  scale_color_discrete(name = "Componente estacional", 
                       labels = c("Defunciones", "Defunciones por día")) +
  theme(legend.position=c(0.15,0.15))
```

\
\

# Análisis del residuo del método de descomposición

Los métodos de descomposición no requieren de ningún supuesto sobre los residuos. Sin embargo, vamos a realizar una análisis gráfico informal de estos, adelantando conceptos que irán siendo necesarios según avancemos en el ejemplo.

Como la descomposición es multiplicativa, el error es en tanto por uno y tiene media 1. Para analizar las propiedades del residuo como ruido blanco vamos a centrar el error en torno al valor de cero sacando el logaritmo. Es decir, $R_t = \log(e_t)$.

La @fig-ECBError muestra el error y los intervalos de confianza (IC) al 95% (líneas en verde) y al 99.7% (líneas en rojo). Se observan cinco valores claramente extremos que cruzan el IC(99.7%) por la parte superior de la gráfica. Corresponden a los meses de enero de 1981, febrero de 1983, enero de 1985, febrero de 1999 y febrero de 2012, en los que los casos de defunciones por enfermedades cerebrovasculares fueron muy superiores respecto de lo esperado. Como todos los casos tienen lugar en invierno, podrían estar relacionados con la temperatura media invernal en esos años.

Si relajamos el umbral a las 2.5 desviaciones típicas, aparecen otros 9 meses, algunos en los primeros años de la serie y otros tras la pandemia. En concreto, tras la pandemia aparecen como meses atípicos febrero de 2021 y 2022, con un número de defunciones inferior a lo esperado, y julio de 2022, con un número de defunciones superior al esperado. Habría que analizar si estos meses atípicos están relacionado con la Covid-19.

```{r}
#| label: fig-ECBError
#| fig-cap: "Error + Intervención"
error <- log(remainder(DefEnfCerDesMul))

sderror <- sd(error, na.rm = TRUE)

autoplot(error,
         xlab = "",
         ylab = "Error",
         main = "",
         colour = "black") +
  geom_hline(yintercept = c(3, 2, -2, -3)*sderror, 
             colour = c("red", "green", "green", "red"),
             lty = 2) + 
  scale_x_continuous(breaks= seq(1980, 2024, 4)) 

fechas <- format(seq(as.Date("1980-01-01"), as.Date("2023-12-01"), "month"), "%Y-%m")
fechas[abs(error) > 3 * sderror]
```

La prueba de Tukey, mucho más conservadora, no identifica ningún mes como atípico.
```{r}
atipicos <- tsoutliers(error)
fechas[atipicos$index]
```

Por otro lado, el residuo parece incorrelado y homocedástico. Para analizar la incorrelación hemos obtenido la gráfica del error de un periodo $e_t$ respecto del error del periodo previo $e_{t-1}$ (véase @fig-ECBIncorrelacion). Si el error es incorrelado deberemos ver una nube de puntos sin ningún patrón, como así ocurre.

```{r}
#| label: fig-ECBIncorrelacion
#| fig-height: 4
#| fig-cap: "Análisis de la incorrelación"
gglagplot(error, 
          lags = 1, 
          do.lines = FALSE, 
          colour = FALSE, 
          main = "")
```

Para analizar mejor la homocedasticidad hemos usado la variabilidad del error dentro de cada año. Si la variabilidad intraanual se mantiene constante, podemos asumir la hipótesis de homocedasticidad. La @fig-ECBHomocedasticidad indica que ese parece ser el caso dado que conforme pasan los años la desviación típica del residuo se mantiene.

En todo caso este es sólo un análisis gráfico sin ninguna validez estadística.

```{r}
#| label: fig-ECBHomocedasticidad
#| fig-cap: "Análisis de homocedasticidad"
DesviacionAnual = aggregate(error, FUN = sd)
ggplot() +
  geom_point(aes(x = time(DesviacionAnual), y = DesviacionAnual), size = 2) +
  ggtitle("") +
  xlab("") +
  ylab("Desviación estándar del error") 
```


\
\
\
\

